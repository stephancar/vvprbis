<!doctype html>
<html lang="en-BE">
  <head>
    <meta charset="UTF-8" />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- ✅ Non-zoomable on mobile (no double-tap zoom / no pinch zoom) -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />

    <!-- ✅ SEO -->
    <title>VVPR-bis Dividend Calculator (Belgium) — Withholding Tax / Roerende Voorheffing (RV)</title>
    <meta
      name="description"
      content="Free VVPR-bis dividend calculator for Belgium. Enter gross dividend, withholding tax (roerende voorheffing / RV), or net dividend and compute the rest instantly. Rates: 15%, 18%, 20%, 30%. No cookies, no ads."
    />
    <link rel="canonical" href="https://steefware.com/vvprbis/" />
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <meta name="googlebot" content="index,follow" />

    <!-- ✅ Open Graph / Twitter (remove image lines if you don’t have them) -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="steefware" />
    <meta property="og:title" content="VVPR-bis Dividend Calculator (Belgium) — Withholding Tax / RV" />
    <meta
      property="og:description"
      content="Compute gross, net and Belgian withholding tax (roerende voorheffing / RV). Enter one value and get the rest. Rates: 15%, 18%, 20%, 30%."
    />
    <meta property="og:url" content="https://steefware.com/vvprbis/" />
    <meta property="og:image" content="https://steefware.com/og/vvprbis.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="VVPR-bis Dividend Calculator (Belgium) — Withholding Tax / RV" />
    <meta
      name="twitter:description"
      content="Enter gross, withholding tax (RV), or net dividend and compute the rest instantly. No cookies, no ads."
    />
    <meta name="twitter:image" content="https://steefware.com/og/vvprbis.png" />

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PWA niceties (optional; keep even if you don’t add a manifest yet) -->
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <!-- <link rel="manifest" href="/manifest.webmanifest" /> -->

    <!-- ✅ Structured data: WebApplication + FAQ -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "WebSite",
            "@id": "https://steefware.com/#website",
            "url": "https://steefware.com/",
            "name": "steefware",
            "description": "Simple tools. No cookies, no ads.",
            "inLanguage": "en-BE"
          },
          {
            "@type": "WebPage",
            "@id": "https://steefware.com/vvprbis/#webpage",
            "url": "https://steefware.com/vvprbis/",
            "name": "VVPR-bis Dividend Calculator (Belgium)",
            "isPartOf": { "@id": "https://steefware.com/#website" },
            "inLanguage": "en-BE",
            "about": [
              { "@type": "Thing", "name": "VVPR-bis" },
              { "@type": "Thing", "name": "Belgian withholding tax" },
              { "@type": "Thing", "name": "Roerende voorheffing" }
            ]
          },
          {
            "@type": "SoftwareApplication",
            "@id": "https://steefware.com/vvprbis/#app",
            "name": "VVPR-bis Dividend Calculator",
            "applicationCategory": "FinanceApplication",
            "operatingSystem": "Any",
            "isAccessibleForFree": true,
            "url": "https://steefware.com/vvprbis/",
            "description": "Calculator for Belgian dividends: enter gross dividend, withholding tax (roerende voorheffing / RV), or net dividend to compute the rest. Supports 15%, 18%, 20%, and 30% rates.",
            "creator": {
              "@type": "Organization",
              "name": "steefware",
              "url": "https://steefware.com/"
            },
            "offers": { "@type": "Offer", "price": "0", "priceCurrency": "EUR" }
          },
          {
            "@type": "FAQPage",
            "@id": "https://steefware.com/vvprbis/#faq",
            "mainEntity": [
              {
                "@type": "Question",
                "name": "What does this VVPR-bis calculator compute?",
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": "It computes the relationship between gross dividend, withholding tax (roerende voorheffing / RV), and net dividend using the selected rate (15%, 18%, 20%, or 30%)."
                }
              },
              {
                "@type": "Question",
                "name": "Do you store my data or use cookies?",
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": "No. This tool runs in your browser. It does not use cookies or analytics."
                }
              },
              {
                "@type": "Question",
                "name": "Does this tool confirm VVPR-bis eligibility?",
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": "No. It is an arithmetic helper. Eligibility and the correct rate depend on your situation—confirm with your accountant."
                }
              }
            ]
          }
        ]
      }
    </script>

    <style>
      /* --- Mobile interaction guards (helps prevent double-tap/pinch behaviors) --- */
      html,
      body {
        height: 100%;
        overscroll-behavior: none;
      }
      body {
        -webkit-text-size-adjust: 100%;
        touch-action: manipulation; /* discourages double-tap zoom on many browsers */
      }

      /* Steefware-style: keep native, but make range consistent */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 28px;
        background: transparent;
      }
      input[type="range"]:focus {
        outline: none;
      }

      input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
        border-radius: 999px;
        background: #000;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: #fff;
        border: 2px solid #000;
        margin-top: -6px;
        box-shadow: 2px 2px 0 0 #000;
      }

      input[type="range"]::-moz-range-track {
        height: 6px;
        border-radius: 999px;
        background: #000;
      }
      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: #fff;
        border: 2px solid #000;
        box-shadow: 2px 2px 0 0 #000;
      }
    </style>
  </head>

  <body class="bg-white text-black antialiased">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
      <!-- Header (steefware style) -->
      <header class="flex items-center justify-between py-6">
        <a
          href="/"
          class="inline-flex items-center gap-2 rounded-xl border-2 border-black px-3 py-2 text-sm font-black tracking-tight shadow-[4px_4px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
          aria-label="steefware home"
        >
          <span class="inline-block h-2 w-2 rounded-full bg-fuchsia-500"></span>
          steefware.com
        </a>

        <nav class="flex items-center gap-3 text-sm font-semibold">
          <a
            href="#tool"
            class="rounded-lg px-2 py-1 underline underline-offset-4 decoration-2 decoration-black/30 transition-colors duration-150 hover:decoration-black focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
            >app</a
          >
          <a
            href="#about"
            class="rounded-lg px-2 py-1 underline underline-offset-4 decoration-2 decoration-black/30 transition-colors duration-150 hover:decoration-black focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
            >about</a
          >
        </nav>
      </header>

      <!-- Hero -->
      <main class="pb-14 pt-2">
        <section class="relative">
          <div class="rounded-3xl border-2 border-black p-6 shadow-[8px_8px_0_0_#000] sm:p-10">
            <h1 class="text-balance text-4xl font-black tracking-tight sm:text-6xl">
              VVPR-bis Dividend Calculator
            </h1>

            <div class="mt-6 space-y-2 text-base font-semibold sm:text-xl">
              <p>
                Belgium: compute <span class="font-black">gross</span>,
                <span class="font-black">withholding tax</span> (<span class="font-black">roerende voorheffing</span> / RV),
                and <span class="font-black">net dividend</span>.
              </p>
              <p class="text-sm sm:text-base">
                Enter <span class="font-black">one</span> value and we compute the rest. No cookies. No ads. Runs entirely in your browser.
              </p>
            </div>

            <div
              class="pointer-events-none absolute -right-2 -top-2 hidden h-10 w-10 rotate-6 rounded-2xl border-2 border-black bg-amber-300 shadow-[4px_4px_0_0_#000] sm:block"
              aria-hidden="true"
            ></div>
          </div>
        </section>

        <!-- Tool -->
        <section id="tool" class="mt-12">
          <div class="flex items-end justify-between gap-4">
            <h2 class="text-sm font-black uppercase tracking-widest">Tool</h2>
            <div id="lastRun" class="text-xs font-semibold text-black/60"></div>
          </div>

          <div class="mt-5 grid grid-cols-1 gap-5 md:grid-cols-2">
            <!-- Inputs -->
            <div
              class="rounded-2xl border-2 border-black bg-white p-6 shadow-[6px_6px_0_0_#000]"
              aria-label="Inputs"
            >
              <div class="flex items-start justify-between gap-4">
                <h3 class="text-xl font-black tracking-tight">Inputs</h3>
                <span
                  id="unitBadge"
                  class="inline-flex items-center rounded-full border-2 border-black px-3 py-1 text-xs font-black shadow-[3px_3px_0_0_#000]"
                  title="Units used by this calculator"
                >
                  € / %
                </span>
              </div>

              <!-- Inputs -->
              <div class="mt-5 grid grid-cols-1 gap-4">
                <!-- Rate segmented -->
                <div>
                  <label class="block text-xs font-black uppercase tracking-widest">
                    Withholding rate (RV)
                  </label>
                  <div
                    class="mt-2 flex flex-wrap gap-2"
                    role="group"
                    aria-label="Withholding tax rate"
                  >
                    <button
                      type="button"
                      class="segBtn inline-flex flex-1 items-center justify-center rounded-xl border-2 border-black bg-white px-3 py-2 text-sm font-black shadow-[3px_3px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                      data-rate="0.15"
                      aria-pressed="false"
                    >
                      15%
                    </button>
                    <button
                      type="button"
                      class="segBtn inline-flex flex-1 items-center justify-center rounded-xl border-2 border-black bg-white px-3 py-2 text-sm font-black shadow-[3px_3px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                      data-rate="0.18"
                      aria-pressed="false"
                    >
                      18%
                    </button>
                    <button
                      type="button"
                      class="segBtn inline-flex flex-1 items-center justify-center rounded-xl border-2 border-black bg-white px-3 py-2 text-sm font-black shadow-[3px_3px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                      data-rate="0.20"
                      aria-pressed="false"
                    >
                      20%
                    </button>
                    <button
                      type="button"
                      class="segBtn inline-flex flex-1 items-center justify-center rounded-xl border-2 border-black bg-black px-3 py-2 text-sm font-black text-white shadow-[3px_3px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                      data-rate="0.30"
                      aria-pressed="true"
                      title="Default"
                    >
                      30%
                    </button>
                  </div>
                  <input type="hidden" id="rate" value="0.30" />
                  <p class="mt-1 text-xs font-semibold text-black/60">Tax = Gross × rate</p>
                </div>

                <!-- Currency -->
                <div>
                  <label for="currency" class="block text-xs font-black uppercase tracking-widest">
                    Currency
                  </label>
                  <select
                    id="currency"
                    class="mt-2 w-full rounded-xl border-2 border-black px-3 py-2 text-sm font-semibold shadow-[3px_3px_0_0_#000] focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                  >
                    <option value="€" selected>€ (EUR)</option>
                    <option value="">(none)</option>
                    <option value="$">$ (USD)</option>
                    <option value="£">£ (GBP)</option>
                  </select>
                  <p class="mt-1 text-xs font-semibold text-black/60">Formatting only (no FX conversion).</p>
                </div>

                <!-- Gross -->
                <div>
                  <label for="gross" class="block text-xs font-black uppercase tracking-widest">
                    Gross dividend
                  </label>
                  <div class="mt-2 flex items-stretch gap-2">
                    <span
                      id="pGross"
                      class="inline-flex w-11 items-center justify-center rounded-xl border-2 border-black bg-white text-sm font-black shadow-[3px_3px_0_0_#000]"
                      aria-hidden="true"
                      >€</span
                    >
                    <input
                      id="gross"
                      inputmode="decimal"
                      placeholder="1000.00"
                      class="w-full rounded-xl border-2 border-black px-3 py-2 text-sm font-semibold shadow-[3px_3px_0_0_#000] focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                    />
                  </div>
                  <p class="mt-1 text-xs font-semibold text-black/60">Gross = Net + Tax</p>
                </div>

                <!-- Tax -->
                <div>
                  <label for="tax" class="block text-xs font-black uppercase tracking-widest">
                    Withholding tax (RV)
                  </label>
                  <div class="mt-2 flex items-stretch gap-2">
                    <span
                      id="pTax"
                      class="inline-flex w-11 items-center justify-center rounded-xl border-2 border-black bg-white text-sm font-black shadow-[3px_3px_0_0_#000]"
                      aria-hidden="true"
                      >€</span
                    >
                    <input
                      id="tax"
                      inputmode="decimal"
                      placeholder="300.00"
                      class="w-full rounded-xl border-2 border-black px-3 py-2 text-sm font-semibold shadow-[3px_3px_0_0_#000] focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                    />
                  </div>
                  <p class="mt-1 text-xs font-semibold text-black/60">Gross = Tax ÷ rate</p>
                </div>

                <!-- Net -->
                <div>
                  <label for="net" class="block text-xs font-black uppercase tracking-widest">
                    Net dividend
                  </label>
                  <div class="mt-2 flex items-stretch gap-2">
                    <span
                      id="pNet"
                      class="inline-flex w-11 items-center justify-center rounded-xl border-2 border-black bg-white text-sm font-black shadow-[3px_3px_0_0_#000]"
                      aria-hidden="true"
                      >€</span
                    >
                    <input
                      id="net"
                      inputmode="decimal"
                      placeholder="700.00"
                      class="w-full rounded-xl border-2 border-black px-3 py-2 text-sm font-semibold shadow-[3px_3px_0_0_#000] focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                    />
                  </div>
                  <p class="mt-1 text-xs font-semibold text-black/60">Gross = Net ÷ (1 − rate)</p>
                </div>
              </div>

              <!-- Buttons -->
              <div class="mt-6 flex flex-col gap-3 sm:flex-row">
                <button
                  id="calcBtn"
                  class="inline-flex items-center justify-center rounded-xl border-2 border-black bg-black px-4 py-2 text-sm font-black text-white shadow-[4px_4px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                  type="button"
                >
                  Calculate
                </button>

                <button
                  id="useLastBtn"
                  class="inline-flex items-center justify-center rounded-xl border-2 border-black bg-white px-4 py-2 text-sm font-black shadow-[4px_4px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                  type="button"
                >
                  Use last edited only
                </button>

                <button
                  id="resetBtn"
                  class="inline-flex items-center justify-center rounded-xl border-2 border-black bg-white px-4 py-2 text-sm font-black shadow-[4px_4px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                  type="button"
                >
                  Clear
                </button>

                <button
                  id="copyBtn"
                  class="inline-flex items-center justify-center rounded-xl border-2 border-black bg-white px-4 py-2 text-sm font-black shadow-[4px_4px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                  type="button"
                >
                  Copy result
                </button>

                <button
                  id="shareBtn"
                  class="inline-flex items-center justify-center rounded-xl border-2 border-black bg-white px-4 py-2 text-sm font-black shadow-[4px_4px_0_0_#000] transition-transform duration-150 ease-out hover:-translate-y-0.5 hover:translate-x-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-black focus-visible:ring-offset-4 focus-visible:ring-offset-white"
                  type="button"
                >
                  Share
                </button>
              </div>

              <p class="mt-4 text-xs font-semibold text-black/60">
                Tip: press <span class="font-mono font-black">Enter</span> in any field to calculate. Use commas or dots for decimals.
              </p>

              <div
                id="errorBox"
                class="mt-5 hidden rounded-2xl border-2 border-black bg-amber-300 p-4 text-sm font-black shadow-[4px_4px_0_0_#000]"
                role="alert"
              >
                Error: <span id="errorMsg"></span>
              </div>

              <div
                id="bindingError"
                class="mt-5 hidden rounded-2xl border-2 border-black bg-amber-300 p-4 text-sm font-black shadow-[4px_4px_0_0_#000]"
              >
                Binding error: missing required DOM element(s). Check console.
              </div>
            </div>

            <!-- Results -->
            <div
              class="rounded-2xl border-2 border-black bg-white p-6 shadow-[6px_6px_0_0_#000]"
              aria-label="Results"
            >
              <div class="flex items-start justify-between gap-4">
                <h3 class="text-xl font-black tracking-tight">Results</h3>
                <span
                  id="statusBadge"
                  class="inline-flex items-center rounded-full border-2 border-black px-3 py-1 text-xs font-black shadow-[3px_3px_0_0_#000]"
                  title="Result status"
                >
                  OK
                </span>
              </div>

              <div class="mt-5 rounded-2xl border-2 border-black p-6 shadow-[6px_6px_0_0_#000]">
                <div class="text-xs font-black uppercase tracking-widest text-black/70">Net dividend</div>
                <div id="primaryOut" class="mt-2 text-5xl font-black tracking-tight sm:text-6xl">
                  —
                </div>

                <div id="secondaryOut" class="mt-3 text-sm font-semibold text-black/70">
                  —
                </div>

                <div class="mt-5">
                  <div class="flex items-center justify-between text-xs font-semibold text-black/60">
                    <span>Gross</span><span>Net</span>
                  </div>
                  <div class="mt-2 rounded-full border-2 border-black p-1">
                    <div
                      id="bar"
                      class="h-3 w-0 rounded-full bg-black transition-[width] duration-300"
                      style="width: 0%"
                      aria-label="Net as % of gross"
                    ></div>
                  </div>
                </div>

                <div class="mt-6 h-2 w-16 rounded-full bg-fuchsia-500"></div>
                <p class="mt-3 text-xs font-semibold text-black/60" id="resultNote">
                  Deterministic math. No network calls. Runs entirely in the browser.
                </p>
              </div>
            </div>

            <!-- About -->
            <div id="about" class="md:col-span-2">
              <div class="rounded-2xl border-2 border-black bg-white p-6 shadow-[6px_6px_0_0_#000]">
                <div class="flex items-start justify-between gap-4">
                  <h3 class="text-xl font-black tracking-tight">About</h3>
                  <span
                    class="inline-flex items-center rounded-full border-2 border-black px-3 py-1 text-xs font-black shadow-[3px_3px_0_0_#000]"
                    title="Implementation note"
                  >
                    VVPR-bis
                  </span>
                </div>

                <div class="mt-5 space-y-3 text-sm font-semibold text-black/75">
                  <p>
                    This is an arithmetic helper for Belgian dividends. It computes the relationship between
                    <span class="font-black">gross dividend</span>, <span class="font-black">withholding tax</span>
                    (<span class="font-black">roerende voorheffing</span>, RV) and
                    <span class="font-black">net dividend</span> using a selected rate (15%, 18%, 20% or 30%).
                  </p>
                  <p>
                    It does <span class="font-black">not</span> determine VVPR-bis eligibility. If you’re unsure which rate applies,
                    confirm with your accountant.
                  </p>
                  <p class="text-xs text-black/60">
                    SEO note: page includes structured data (WebApplication + FAQ) and indexable explanatory text.
                  </p>

                  <div class="rounded-xl border-2 border-black p-4 shadow-[3px_3px_0_0_#000]">
                    <div class="text-xs font-black uppercase tracking-widest text-black/70">FAQ</div>
                    <div class="mt-3 space-y-2">
                      <details class="rounded-lg border-2 border-black px-3 py-2 shadow-[2px_2px_0_0_#000]">
                        <summary class="cursor-pointer text-sm font-black">What does this calculator do?</summary>
                        <p class="mt-2 text-sm font-semibold text-black/75">
                          Enter gross, RV, or net dividend and it computes the other values using the selected rate.
                        </p>
                      </details>
                      <details class="rounded-lg border-2 border-black px-3 py-2 shadow-[2px_2px_0_0_#000]">
                        <summary class="cursor-pointer text-sm font-black">Do you store data or use cookies?</summary>
                        <p class="mt-2 text-sm font-semibold text-black/75">
                          No cookies. Inputs may be stored locally in your browser (localStorage) so returning users keep their last values.
                        </p>
                      </details>
                      <details class="rounded-lg border-2 border-black px-3 py-2 shadow-[2px_2px_0_0_#000]">
                        <summary class="cursor-pointer text-sm font-black">Is this legal/tax advice?</summary>
                        <p class="mt-2 text-sm font-semibold text-black/75">
                          No—simple math only. Confirm VVPR-bis eligibility and applicable rate with your accountant.
                        </p>
                      </details>
                    </div>
                  </div>

                  <noscript>
                    <div class="mt-4 rounded-xl border-2 border-black bg-amber-300 p-4 text-sm font-black shadow-[3px_3px_0_0_#000]">
                      JavaScript required: this calculator runs entirely in your browser.
                    </div>
                  </noscript>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const el = (id) => document.getElementById(id);

        // ---- App identity (change per app) ----
        const APP_KEY = "steefware_vvprbis_v1";

        // ---- Binding check ----
        const requiredIds = [
          "rate","currency","gross","tax","net",
          "pGross","pTax","pNet",
          "primaryOut","secondaryOut","bar",
          "resetBtn","lastRun","bindingError",
          "copyBtn","shareBtn","statusBadge",
          "errorBox","errorMsg","unitBadge",
          "calcBtn","useLastBtn"
        ];
        const missing = requiredIds.filter((id) => !el(id));
        if (missing.length) {
          console.error("Binding error. Missing elements:", missing);
          const box = el("bindingError");
          if (box) box.classList.remove("hidden");
          return;
        }

        const rate = el("rate");
        const currency = el("currency");
        const gross = el("gross");
        const tax = el("tax");
        const net = el("net");

        const pGross = el("pGross");
        const pTax = el("pTax");
        const pNet = el("pNet");

        const primaryOut = el("primaryOut");
        const secondaryOut = el("secondaryOut");
        const bar = el("bar");
        const resetBtn = el("resetBtn");
        const lastRun = el("lastRun");
        const copyBtn = el("copyBtn");
        const shareBtn = el("shareBtn");
        const statusBadge = el("statusBadge");
        const errorBox = el("errorBox");
        const errorMsg = el("errorMsg");
        const unitBadge = el("unitBadge");

        const calcBtn = el("calcBtn");
        const useLastBtn = el("useLastBtn");

        let lastEdited = null;

        // ---- Utilities ----
        function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }
        function nowLabel() { return new Date().toLocaleString(); }

        function parseAmount(v) {
          if (v == null) return null;
          const cleaned = String(v).trim().replace(/\s+/g, "").replace(",", ".");
          if (cleaned === "") return null;
          const n = Number(cleaned);
          return Number.isFinite(n) ? n : null;
        }

        function currencySymbol() { return currency.value || ""; }

        function fmtMoney(n) {
          if (!Number.isFinite(n)) return "—";
          const sym = currencySymbol();
          const abs = Math.abs(n);
          const s = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(abs);
          return (n < 0 ? "−" : "") + sym + s;
        }

        function showError(msg) {
          errorMsg.textContent = msg;
          errorBox.classList.remove("hidden");
          statusBadge.textContent = "Check";
        }

        function clearError() {
          errorBox.classList.add("hidden");
          errorMsg.textContent = "";
          statusBadge.textContent = "OK";
        }

        function updatePrefixes() {
          const sym = currencySymbol() || " ";
          pGross.textContent = sym;
          pTax.textContent = sym;
          pNet.textContent = sym;
        }

        // ---- Persistence ----
        function loadState() {
          try {
            const raw = localStorage.getItem(APP_KEY);
            if (!raw) return;
            const s = JSON.parse(raw);
            if (!s || typeof s !== "object") return;
            if (s.rate != null) rate.value = String(s.rate);
            if (s.currency != null) currency.value = String(s.currency);
            if (s.gross != null) gross.value = String(s.gross);
            if (s.tax != null) tax.value = String(s.tax);
            if (s.net != null) net.value = String(s.net);
            if (s.lastEdited != null) lastEdited = String(s.lastEdited);
          } catch (_) {}
        }

        function saveState() {
          try {
            const s = {
              rate: rate.value,
              currency: currency.value,
              gross: gross.value,
              tax: tax.value,
              net: net.value,
              lastEdited
            };
            localStorage.setItem(APP_KEY, JSON.stringify(s));
          } catch (_) {}
        }

        function filledCount() {
          const g = parseAmount(gross.value);
          const t = parseAmount(tax.value);
          const n = parseAmount(net.value);
          return [g, t, n].filter((v) => v !== null).length;
        }

        function pickMode() {
          if (lastEdited && parseAmount(el(lastEdited).value) !== null) return lastEdited;
          const filled = ["gross", "tax", "net"].filter((k) => parseAmount(el(k).value) !== null);
          return filled.length === 1 ? filled[0] : null;
        }

        function setSegUIFromRate() {
          const r = String(rate.value);
          const buttons = Array.from(document.querySelectorAll(".segBtn"));
          buttons.forEach((b) => {
            const isOn = b.getAttribute("data-rate") === r;
            b.setAttribute("aria-pressed", isOn ? "true" : "false");
            // toggle steefware black/white style
            b.classList.toggle("bg-black", isOn);
            b.classList.toggle("text-white", isOn);
            b.classList.toggle("bg-white", !isOn);
            b.classList.toggle("text-black", !isOn);
          });
        }

        function calculate({ silent = false } = {}) {
          clearError();

          const r = parseAmount(rate.value);
          if (!(r >= 0 && r < 1)) {
            showError("Invalid rate selected.");
            primaryOut.textContent = "—";
            secondaryOut.textContent = "—";
            bar.style.width = "0%";
            lastRun.textContent = `Live: ${nowLabel()}`;
            saveState();
            return;
          }

          const mode = pickMode();
          const c = filledCount();

          if (!mode) {
            if (!silent) {
              showError(
                c === 0
                  ? "Enter a value in exactly one field (Gross, Tax, or Net)."
                  : "Multiple fields are filled. Click “Use last edited only” or clear extra fields."
              );
            }
            primaryOut.textContent = "—";
            secondaryOut.textContent = "—";
            bar.style.width = "0%";
            lastRun.textContent = `Live: ${nowLabel()}`;
            saveState();
            return;
          }

          const gIn = parseAmount(gross.value);
          const tIn = parseAmount(tax.value);
          const nIn = parseAmount(net.value);

          let G, T, N;

          if (mode === "gross") {
            G = gIn;
            T = G * r;
            N = G - T;
          } else if (mode === "tax") {
            T = tIn;
            if (r === 0) {
              showError("Rate is 0%, tax input cannot be used.");
              return;
            }
            G = T / r;
            N = G - T;
          } else if (mode === "net") {
            N = nIn;
            if (r === 1) {
              showError("Rate is 100%, net input cannot be used.");
              return;
            }
            G = N / (1 - r);
            T = G - N;
          }

          if (![G, T, N].every(Number.isFinite)) {
            showError("Please enter a valid number.");
            return;
          }

          if (G < 0 || T < 0 || N < 0) {
            showError("Computed a negative value — check your input.");
            return;
          }

          // write outputs
          primaryOut.textContent = fmtMoney(N);
          const eff = G !== 0 ? (T / G) : NaN;

          secondaryOut.innerHTML =
            `<div class="space-y-1">` +
              `<div><span class="font-black">Gross:</span> ${fmtMoney(G)}</div>` +
              `<div><span class="font-black">Tax (RV):</span> ${fmtMoney(T)} <span class="text-black/60">(${(r * 100).toFixed(0)}%)</span></div>` +
              `<div><span class="font-black">Net:</span> ${fmtMoney(N)} <span class="text-black/60">(effective: ${Number.isFinite(eff) ? (eff * 100).toFixed(2) + "%" : "—"})</span></div>` +
            `</div>`;

          // progress: net as % of gross
          const pct = G > 0 ? (N / G) * 100 : 0;
          bar.style.width = `${clamp(pct, 0, 100)}%`;

          // fill other fields deterministically (don’t overwrite the user’s input field)
          if (mode !== "gross") gross.value = G.toFixed(2);
          if (mode !== "tax") tax.value = T.toFixed(2);
          if (mode !== "net") net.value = N.toFixed(2);

          unitBadge.textContent = "€ / %";
          statusBadge.textContent = "OK";
          lastRun.textContent = `Live: ${nowLabel()} • Mode: ${mode.toUpperCase()}`;

          saveState();
        }

        function useLastOnly() {
          if (!lastEdited) {
            showError("Click a field, type a value, then try again.");
            return;
          }
          const keep = lastEdited;
          ["gross", "tax", "net"].forEach((k) => { if (k !== keep) el(k).value = ""; });
          clearError();
          statusBadge.textContent = "OK";
          calculate({ silent: true });
        }

        function clearAll() {
          gross.value = "";
          tax.value = "";
          net.value = "";
          lastEdited = null;
          clearError();
          primaryOut.textContent = "—";
          secondaryOut.textContent = "—";
          bar.style.width = "0%";
          statusBadge.textContent = "OK";
          lastRun.textContent = `Live: ${nowLabel()}`;
          saveState();
        }

        // ---- Copy / Share ----
        async function copyResult() {
          const text = [
            `Net: ${primaryOut.textContent}`,
            secondaryOut.textContent.replace(/\s+/g, " ").trim()
          ].join("\n");
          try {
            await navigator.clipboard.writeText(text);
            statusBadge.textContent = "Copied";
            setTimeout(() => (statusBadge.textContent = "OK"), 900);
          } catch (_) {
            showError("Copy failed (clipboard blocked).");
          }
        }

        async function shareResult() {
          const text = `VVPR-bis: Net ${primaryOut.textContent} — ${secondaryOut.textContent.replace(/\s+/g, " ").trim()}`;
          try {
            if (navigator.share) {
              await navigator.share({ title: document.title, text, url: location.href });
              statusBadge.textContent = "Shared";
              setTimeout(() => (statusBadge.textContent = "OK"), 900);
            } else {
              await navigator.clipboard.writeText(text);
              statusBadge.textContent = "Copied";
              setTimeout(() => (statusBadge.textContent = "OK"), 900);
            }
          } catch (_) {
            // user cancel is fine
          }
        }

        // ---- Events ----
        function onEdit(id) {
          lastEdited = id;
          saveState();
        }

        ["gross", "tax", "net"].forEach((id) => {
          el(id).addEventListener("input", () => onEdit(id));
          el(id).addEventListener("keydown", (e) => { if (e.key === "Enter") calculate(); });
        });

        currency.addEventListener("change", () => {
          updatePrefixes();
          calculate({ silent: true });
        });

        calcBtn.addEventListener("click", () => calculate());
        useLastBtn.addEventListener("click", useLastOnly);
        resetBtn.addEventListener("click", clearAll);
        copyBtn.addEventListener("click", copyResult);
        shareBtn.addEventListener("click", shareResult);

        // segmented buttons
        Array.from(document.querySelectorAll(".segBtn")).forEach((btn) => {
          btn.addEventListener("click", () => {
            rate.value = btn.getAttribute("data-rate");
            setSegUIFromRate();
            calculate({ silent: true });
            saveState();
          });
        });

        // ---- Init ----
        loadState();
        updatePrefixes();
        setSegUIFromRate();
        lastRun.textContent = `Live: ${nowLabel()}`;
        calculate({ silent: true });
      })();
    </script>
  </body>
</html>
